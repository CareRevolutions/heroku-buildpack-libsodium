#!/usr/bin/env bash

set -e

BUILD_DIR=$1
CACHE_DIR=$2

indent() {
  sed -u "s/^/       /"
}

VERSION=0.4.2
DIRECTORY=libsodium-$VERSION
TARBALL=$DIRECTORY.tar.gz
TARBALL_URL=https://github.com/jedisct1/libsodium/releases/download/$VERSION/$TARBALL

cd $BUILD_DIR

echo -n "-----> Fetching libsodium... "
curl --silent --remote-name --insecure --location $TARBALL_URL
tar -xf $TARBALL
cd $DIRECTORY
echo "done"

echo -n "-----> Configuring libsodium... "
./configure --silent --disable-debug --disable-dependency-tracking
echo "done"

echo -n "-----> Compiling libsodium... "
make &> /dev/null
echo "done"

echo -n "-----> Saving libsodium.so in cache dir ($CACHE_DIR/$DIRECTORY)... "
mkdir -p $CACHE_DIR/$DIRECTORY
cp src/libsodium/.libs/libsodium.so $CACHE_DIR/$DIRECTORY/libsodium.so
echo "done"
